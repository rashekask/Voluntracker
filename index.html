<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Voluntracker (React + Firebase)</title>
  <style>
    :root { --bg:#0b132b; --card:#1c2541; --accent:#5bc0be; --text:#e6e6e6; --muted:#94a3b8; --danger:#ff8080; }
    body { margin:0; font-family:ui-sans-serif,system-ui; background:var(--bg); color:var(--text); display:grid; place-items:center; min-height:100dvh; }
    .card { width:min(900px, 96vw); background:var(--card); border-radius:16px; padding:24px; box-shadow:0 8px 24px rgba(0,0,0,.35); }
    h1 { margin:0 0 8px; font-size:22px; }
    h2 { margin:16px 0 8px; font-size:18px; }
    .muted { color:var(--muted); font-size:14px; margin-top:0; }
    input, select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2d3a6b; background:#111827; color:var(--text); margin:6px 0; }
    input[type="date"]{ padding:8px 10px; }
    button { padding:10px 14px; border-radius:10px; border:none; background:var(--accent); color:#001217; font-weight:600; cursor:pointer; }
    button.secondary { background:#334155; color:#e2e8f0; }
    button.ghost { background:transparent; border:1px solid #334155; color:#e2e8f0; }
    .row { display:flex; gap:10px; align-items:center; }
    .spread { display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap; }
    .center { text-align:center; }
    .hours { font-size:48px; font-weight:800; letter-spacing:1px; margin:12px 0 8px; }
    .error { color:var(--danger); font-size:13px; min-height:16px; }
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
    .col-6 { grid-column: span 6; }
    .col-12 { grid-column: span 12; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid #2d3a6b; text-align:left; font-size:14px; }
    th { color:#cbd5e1; font-weight:700; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; }
    @media (max-width: 820px) { .col-6 { grid-column: span 12; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React 18 (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, increment, serverTimestamp,
      collection, addDoc, query, orderBy, limit, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // firebase code
    const firebaseConfig = {
      apiKey: "AIzaSyAqF6Ps8PZ-P0iF3JGrycVtBYwIETBYe_U",
      authDomain: "voluntracker-37960.firebaseapp.com",
      projectId: "voluntracker-37960",
      storageBucket: "voluntracker-37960.firebasestorage.app",
      messagingSenderId: "882313290014",
      appId: "1:882313290014:web:be223f5fd822aeac78290f",
      measurementId: "G-8T5Z29Q16S"

    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    // Helpers
    const { useState, useEffect, useRef } = React;
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmtDate = (d) => {
      try { return new Date(d).toLocaleDateString(); } catch { return ""; }
    };

    // Firestore refs
    const profileRef = (uid) => doc(db, "users", uid, "profile", "profile");
    const entriesCol = (uid) => collection(db, "users", uid, "entries");

    async function ensureProfile(uid) {
      const ref = profileRef(uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { totalHours: 0, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
      }
    }

    function AuthCard({ onDone }) {
      const [email, setEmail] = useState("");
      const [pass, setPass] = useState("");
      const [mode, setMode] = useState("login");
      const [err, setErr] = useState("");

      const submit = async () => {
        setErr("");
        try {
          if (mode === "login") {
            await signInWithEmailAndPassword(auth, email.trim(), pass);
          } else {
            const cred = await createUserWithEmailAndPassword(auth, email.trim(), pass);
            await ensureProfile(cred.user.uid);
          }
          onDone();
        } catch (e) {
          setErr(e.message || "Something went wrong");
        }
      };

      return (
        React.createElement("div", { className:"card" },
          React.createElement("h1", null, "Voluntracker"),
          React.createElement("p", { className:"muted" }, "Email + password. Sessions persist."),
          React.createElement("input", { placeholder:"Email", value:email, onChange:e=>setEmail(e.target.value) }),
          React.createElement("input", { placeholder:"Password", type:"password", value:pass, onChange:e=>setPass(e.target.value) }),
          React.createElement("div", { className:"error" }, err),
          React.createElement("div", { className:"row" },
            React.createElement("button", { onClick:submit }, mode === "login" ? "Sign In" : "Create Account"),
            React.createElement("button", { className:"secondary", onClick:()=>setMode(mode==="login"?"register":"login") },
              mode === "login" ? "Need an account?" : "Have an account?")
          )
        )
      );
    }

    function Dashboard({ user }) {
      const [hours, setHours] = useState(0);
      const [loading, setLoading] = useState(true);
      const [err, setErr] = useState("");
      const [entries, setEntries] = useState([]);

      // New-entry form refs
      const whatRef = useRef();
      const dateRef = useRef();
      const hrsRef  = useRef();

      // Load profile + subscribe to changes
      useEffect(() => {
        (async () => {
          await ensureProfile(user.uid);
          const unsubProfile = onSnapshot(profileRef(user.uid), (snap) => {
            const data = snap.data() || { totalHours: 0 };
            setHours(Number(data.totalHours || 0));
            setLoading(false);
          });
          // Subscribe to latest 20 entries
          const q = query(entriesCol(user.uid), orderBy("performedAt", "desc"), limit(20));
          const unsubEntries = onSnapshot(q, (snap) => {
            const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
            setEntries(list);
          });
          return () => { unsubProfile(); unsubEntries(); };
        })();
      }, [user.uid]);

      // Log helpers
      const logAdjustment = async (delta, kindNote) => {
        const ref = entriesCol(user.uid);
        await addDoc(ref, {
          kind: "adjustment",
          delta: Number(delta),
          note: kindNote || "",
          performedAt: serverTimestamp(),
          createdAt: serverTimestamp()
        });
      };

      const bump = async (delta) => {
        setErr("");
        try {
          await updateDoc(profileRef(user.uid), { totalHours: increment(delta), updatedAt: serverTimestamp() });
          await logAdjustment(delta, delta > 0 ? "quick +1" : "quick -1");
        } catch (e) {
          setErr(e.message || "Update failed");
        }
      };

      const setCustom = async () => {
        const v = parseFloat(hrsRef.current?.value || "0");
        if (isNaN(v)) return;
        setErr("");
        try {
          const delta = v - Number(hours || 0);
          await setDoc(profileRef(user.uid), { totalHours: v, updatedAt: serverTimestamp() }, { merge: true });
          await logAdjustment(delta, "set exact");
          hrsRef.current.value = "";
        } catch (e) {
          setErr(e.message || "Update failed");
        }
      };

      const addManualEntry = async () => {
        const what = (whatRef.current?.value || "").trim();
        const dstr = dateRef.current?.value || "";
        const h = parseFloat(document.getElementById("manualHours").value || "0");
        if (!what || !dstr || isNaN(h)) { setErr("Please fill What, When, and Hours."); return; }
        setErr("");
        try {
          const dt = new Date(`${dstr}T00:00:00`);
          await addDoc(entriesCol(user.uid), {
            kind: "manual",
            title: what,
            hours: Number(h),
            performedAt: Timestamp.fromDate(dt),
            createdAt: serverTimestamp()
          });
          await updateDoc(profileRef(user.uid), { totalHours: increment(Number(h)), updatedAt: serverTimestamp() });
          // clear inputs
          whatRef.current.value = "";
          dateRef.current.value = "";
          document.getElementById("manualHours").value = "";
        } catch (e) {
          setErr(e.message || "Could not add entry");
        }
      };

      return (
        React.createElement("div", { className:"card" },
          React.createElement("div", { className:"spread" },
            React.createElement("h1", null, "My Hours"),
            React.createElement("div", { className:"row" },
              React.createElement("span", { className:"pill" }, `Signed in as ${user.email}`),
              React.createElement("button", { className:"secondary", onClick:()=>signOut(auth) }, "Sign Out")
            )
          ),

          loading
            ? React.createElement("p", { className:"muted" }, "Loadingâ€¦")
            : React.createElement("div", null,
                React.createElement("div", { className:"center" },
                  React.createElement("div", { className:"hours" }, hours.toFixed(1).replace(/\.0$/, "")),
                  React.createElement("div", { className:"row", style:{justifyContent:'center'} },
                    React.createElement("button", { onClick:()=>bump(-1) }, "â€“1"),
                    React.createElement("button", { onClick:()=>bump(+1) }, "+1")
                  ),
                  React.createElement("div", { className:"row", style:{marginTop:'10px', justifyContent:'center'} },
                    React.createElement("input", { id:"manualSet", ref:hrsRef, placeholder:"Set total to (e.g., 12.5)" }),
                    React.createElement("button", { onClick:setCustom }, "Set")
                  )
                ),

                React.createElement("div", { className:"grid", style:{marginTop:'18px'} },
                  React.createElement("div", { className:"col-6" },
                    React.createElement("h2", null, "Add Log Entry"),
                    React.createElement("p", { className:"muted" }, "Manual entry: What, When, and Hours. Adds to total and appears in Recent Activity."),
                    React.createElement("input", { ref:whatRef, placeholder:"What (e.g., Food bank sorting)" }),
                    React.createElement("div", { className:"row" },
                      React.createElement("input", { ref:dateRef, type:"date", style:{maxWidth:'50%'} }),
                      React.createElement("input", { id:"manualHours", placeholder:"Hours (e.g., 2.5)", style:{maxWidth:'50%'} })
                    ),
                    React.createElement("div", { className:"row" },
                      React.createElement("button", { onClick:addManualEntry }, "Add Entry"),
                      React.createElement("button", { className:"ghost", onClick:()=>{ if(whatRef.current) whatRef.current.value=""; if(dateRef.current) dateRef.current.value=""; const el=document.getElementById('manualHours'); if(el) el.value=""; } }, "Clear")
                    ),
                    React.createElement("div", { className:"error", style:{marginTop:'6px'} }, err)
                  ),

                  React.createElement("div", { className:"col-6" },
                    React.createElement("h2", null, "Recent Activity"),
                    entries.length === 0
                      ? React.createElement("p", { className:"muted" }, "No activity yet.")
                      : React.createElement("div", { style:{overflowX:'auto'} },
                          React.createElement("table", null,
                            React.createElement("thead", null,
                              React.createElement("tr", null,
                                React.createElement("th", null, "When"),
                                React.createElement("th", null, "What"),
                                React.createElement("th", null, "Hours / Î”"),
                                React.createElement("th", null, "Type")
                              )
                            ),
                            React.createElement("tbody", null,
                              entries.map(e =>
                                React.createElement("tr", { key:e.id },
                                  React.createElement("td", null, e.performedAt?.toDate ? fmtDate(e.performedAt.toDate()) : fmtDate(e.performedAt)),
                                  React.createElement("td", null, e.kind === "manual" ? (e.title || "") : (e.note || "")),
                                  React.createElement("td", null,
                                    e.kind === "manual"
                                      ? (Number(e.hours || 0).toFixed(1).replace(/\.0$/, "") + "h")
                                      : ((Number(e.delta) > 0 ? "+" : "") + String(Number(e.delta || 0)))
                                  ),
                                  React.createElement("td", null, e.kind)
                                )
                              )
                            )
                          )
                        )
                  )
                )
              )
        )
      );
    }

    function App() {
      const [user, setUser] = useState(null);
      const [ready, setReady] = useState(false);

      useEffect(() => {
        const unsub = onAuthStateChanged(auth, async (u) => {
          setUser(u || null);
          if (!ready) await sleep(50);
          setReady(true);
        });
        return () => unsub();
      }, []);

      if (!ready) return React.createElement("p", { className:"muted" }, "Startingâ€¦");
      return user
        ? React.createElement(Dashboard, { user })
        : React.createElement(AuthCard, { onDone:()=>{} });
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(React.createElement(App));
  </script>
</body>
</html>
